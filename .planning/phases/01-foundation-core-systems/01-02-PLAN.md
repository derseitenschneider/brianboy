---
phase: 01-foundation-core-systems
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/components/ThemeScript.astro
  - src/components/ThemeToggle.astro
  - src/layouts/BaseLayout.astro
  - src/pages/index.astro
autonomous: true

must_haves:
  truths:
    - "User can toggle between dark and light themes"
    - "Theme does not flash on page load"
    - "Theme preference persists across page refresh"
    - "System preference is respected when no stored preference exists"
  artifacts:
    - path: "src/components/ThemeScript.astro"
      provides: "Blocking theme detection script"
      contains: "is:inline"
    - path: "src/components/ThemeToggle.astro"
      provides: "Theme toggle button component"
      contains: "theme-toggle"
    - path: "src/layouts/BaseLayout.astro"
      provides: "Base HTML layout with theme script"
      contains: "ThemeScript"
  key_links:
    - from: "src/layouts/BaseLayout.astro"
      to: "src/components/ThemeScript.astro"
      via: "Component import in head"
      pattern: "import.*ThemeScript"
    - from: "src/components/ThemeScript.astro"
      to: "localStorage"
      via: "Theme persistence"
      pattern: "localStorage\\.getItem.*theme"
    - from: "src/components/ThemeToggle.astro"
      to: "window.setTheme"
      via: "Theme toggle function"
      pattern: "window.*setTheme"
---

<objective>
Implement flash-free dark/light theme toggle with persistence

Purpose: Users expect immediate theme application without jarring flashes. This system uses a blocking inline script to detect preference before first paint, preventing FOUC (Flash of Unstyled Content).

Output: Theme toggle component and blocking script that provides seamless theme switching
</objective>

<execution_context>
@/Users/brianboy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianboy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-systems/01-RESEARCH.md

Critical research findings:
1. ThemeScript MUST use is:inline directive to prevent bundling
2. ThemeScript MUST be in <head> BEFORE any CSS imports
3. Use data-theme attribute (not class="dark") with @custom-variant in CSS
4. Expose setTheme/getTheme on window for toggle component
5. Listen for system preference changes when no stored preference
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blocking theme detection script</name>
  <files>
    src/components/ThemeScript.astro
  </files>
  <action>
Create src/components/ThemeScript.astro with:

1. A script tag with is:inline directive (CRITICAL - prevents bundling/deferring)
2. IIFE that runs immediately:
   - Get stored theme from localStorage.getItem('theme')
   - Get system preference via window.matchMedia('(prefers-color-scheme: dark)')
   - Priority: stored preference > system preference > light default
   - Set data-theme attribute on document.documentElement

3. Event listener for system preference changes:
   - Only applies if no stored preference in localStorage
   - Updates data-theme when system changes

4. Expose on window object:
   - window.setTheme(theme) - sets attribute AND stores in localStorage
   - window.getTheme() - returns current theme

The script pattern from research:
```javascript
(function() {
  const root = document.documentElement;

  function getTheme() {
    const stored = localStorage.getItem('theme');
    if (stored === 'dark' || stored === 'light') return stored;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function setTheme(theme) {
    root.setAttribute('data-theme', theme);
    if (theme === 'dark' || theme === 'light') {
      localStorage.setItem('theme', theme);
    }
  }

  setTheme(getTheme());

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      setTheme(e.matches ? 'dark' : 'light');
    }
  });

  window.setTheme = setTheme;
  window.getTheme = getTheme;
})();
```
  </action>
  <verify>
    File exists at src/components/ThemeScript.astro
    Contains is:inline directive
    Contains localStorage operations
    Contains matchMedia listener
  </verify>
  <done>
    - ThemeScript.astro exists
    - Uses is:inline directive
    - Detects stored and system preferences
    - Exposes setTheme/getTheme on window
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BaseLayout and ThemeToggle components</name>
  <files>
    src/layouts/BaseLayout.astro
    src/components/ThemeToggle.astro
  </files>
  <action>
Create src/layouts/BaseLayout.astro:

1. Frontmatter:
   - Import "../styles/global.css"
   - Import ThemeScript from "../components/ThemeScript.astro"
   - Import ThemeToggle from "../components/ThemeToggle.astro"
   - Define Props interface: { title: string; description?: string }
   - Extract props

2. HTML structure:
   - DOCTYPE html
   - html tag with lang="de" (will be dynamic in Plan 03)
   - head section with:
     - meta charset, viewport
     - title from props
     - meta description if provided
     - <ThemeScript /> component BEFORE any other scripts
   - body with:
     - Tailwind classes: min-h-screen bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100
     - transition-colors duration-200
     - A header with <ThemeToggle /> for testing
     - <slot /> for page content

Create src/components/ThemeToggle.astro:

1. A button with id="theme-toggle"
2. Accessible: type="button", aria-label="Toggle theme"
3. Styling: p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors
4. Two SVG icons:
   - Sun icon: hidden dark:block (shows in dark mode, clicking goes to light)
   - Moon icon: block dark:hidden (shows in light mode, clicking goes to dark)
5. Client-side script (NOT is:inline - this one can be bundled):
   - Get button by id
   - Add click listener
   - Toggle theme via window.setTheme()

Sun icon path: "M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"

Moon icon path: "M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
  </action>
  <verify>
    Both files exist
    BaseLayout imports ThemeScript
    ThemeToggle has accessible button
    Both icons present in ThemeToggle
  </verify>
  <done>
    - BaseLayout.astro exists with ThemeScript in head
    - ThemeToggle.astro exists with sun/moon icons
    - Toggle button is accessible (aria-label, type)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update index.astro to use BaseLayout</name>
  <files>
    src/pages/index.astro
  </files>
  <action>
Update src/pages/index.astro to:

1. Remove the direct global.css import (now in BaseLayout)
2. Import BaseLayout from "../layouts/BaseLayout.astro"
3. Wrap content in <BaseLayout title="Brian Boy" description="...">
4. Keep the placeholder content but remove redundant body styling (now in layout)
5. Content should show theme is working:
   - "Brian Boy" heading
   - German placeholder text
   - Perhaps a simple "Theme toggle above ^" message

This validates the complete theme pipeline works.
  </action>
  <verify>
    npm run dev and visit http://localhost:4321
    Page renders with BaseLayout
    ThemeToggle button visible in header
    Clicking toggle switches theme
  </verify>
  <done>
    - index.astro uses BaseLayout
    - Theme toggle button visible
    - Clicking toggle changes theme colors
    - Theme persists after page refresh
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run `npm run dev`
2. Visit http://localhost:4321
3. Verify page loads WITHOUT flash (check by setting localStorage theme and hard refresh)
4. Click theme toggle - should switch between light/dark
5. Refresh page - theme should persist
6. Clear localStorage, refresh - should follow system preference
7. Check DevTools Console - no errors
8. Run `npm run build` - should succeed
</verification>

<success_criteria>
- Theme toggle button visible and clickable
- Clicking toggle switches between light and dark themes
- NO flash of wrong theme on page load (critical)
- Theme persists across page refresh (localStorage)
- System preference respected when no stored preference
- Build completes successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-systems/01-02-SUMMARY.md`
</output>
