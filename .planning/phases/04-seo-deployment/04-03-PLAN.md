---
phase: 04-seo-deployment
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
autonomous: false
requirements:
  - REQ-017

user_setup:
  - service: Hostpoint FTP
    why: "FTP deployment to brianboy.ch hosting"
    env_vars:
      - name: FTP_SERVER
        source: "Hostpoint Control Panel -> FTP/SSH Accounts -> Server hostname"
      - name: FTP_USERNAME
        source: "Hostpoint Control Panel -> FTP/SSH Accounts -> Username"
      - name: FTP_PASSWORD
        source: "Hostpoint Control Panel -> FTP/SSH Accounts -> Password"
    dashboard_config:
      - task: "Add FTP_SERVER, FTP_USERNAME, FTP_PASSWORD as repository secrets"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions -> New repository secret"

must_haves:
  truths:
    - "Push to main triggers the GitHub Actions workflow"
    - "Workflow builds the site before deploying (fails if build fails)"
    - "Built dist/ contents are uploaded to Hostpoint via FTPS"
    - "Workflow does not trigger on branches other than main"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "GitHub Actions CI/CD pipeline for FTP deployment"
      contains: "FTP-Deploy-Action"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "dist/"
      via: "npm run build produces static files, FTP action uploads them"
      pattern: "local-dir.*dist"
    - from: ".github/workflows/deploy.yml"
      to: "GitHub Secrets"
      via: "FTP credentials referenced as secrets"
      pattern: "secrets\\.FTP_"
---

<objective>
Create a GitHub Actions workflow that builds the Astro site and deploys it to Hostpoint via FTPS on every push to main.

Purpose: Automated deployment removes manual FTP upload steps and ensures the live site always reflects the latest main branch.
Output: `.github/workflows/deploy.yml` workflow file.
</objective>

<execution_context>
@/Users/brianboy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianboy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-seo-deployment/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions deployment workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Create the directory `.github/workflows/` if it does not exist.

Create `.github/workflows/deploy.yml` with this content:

```yaml
name: Deploy to Hostpoint

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          local-dir: ./dist/
          server-dir: ./
```

Key decisions per user requirements:
- Trigger: push to main only (no manual dispatch, no other branches)
- Pipeline: build first, deploy second — if build fails, deploy step never runs
- Protocol: FTPS (encrypted) — Hostpoint likely requires or prefers this over plain FTP
- local-dir: ./dist/ — Astro's static build output
- server-dir: ./ — deploy to root of brianboy.ch (no subdirectory) per user decision
- Node 20 with npm cache for faster CI
- Uses npm ci (not npm install) for reproducible builds

If the user's Hostpoint FTP connection fails with FTPS, they may need to:
1. Try adding `security: loose` under the `with:` section (for self-signed certs)
2. Or switch `protocol: ftps` to `protocol: ftp` if Hostpoint doesn't support FTPS
  </action>
  <verify>Validate YAML syntax: `npx yaml-lint .github/workflows/deploy.yml` or `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"`. Verify the file contains the correct trigger (push to main), build step (npm run build), and deploy step (FTP-Deploy-Action with secrets references).</verify>
  <done>GitHub Actions workflow file exists at .github/workflows/deploy.yml. It triggers on push to main, builds with npm, and deploys via FTPS using repository secrets.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Add FTP credentials as GitHub repository secrets</name>
  <files>GitHub repository settings (no local files)</files>
  <action>
User must add three repository secrets in GitHub (Claude cannot do this — requires GitHub web UI with repo admin access):
1. Go to GitHub repository Settings -> Secrets and variables -> Actions
2. Add `FTP_SERVER` — Hostpoint FTP server hostname (e.g., ftp.brianboy.ch or similar from Hostpoint control panel)
3. Add `FTP_USERNAME` — Hostpoint FTP username
4. Add `FTP_PASSWORD` — Hostpoint FTP password
5. After adding secrets, push to main to trigger the first deployment
6. Check the Actions tab to confirm the workflow runs successfully
7. Visit https://brianboy.ch to verify the site is live
  </action>
  <verify>GitHub Actions workflow completes successfully on push to main. Site loads at https://brianboy.ch.</verify>
  <done>FTP secrets are configured. Push to main triggers build and deploy. Site is live at brianboy.ch.</done>
</task>

</tasks>

<verification>
1. `.github/workflows/deploy.yml` exists with valid YAML
2. Workflow triggers only on push to main
3. Build step runs before deploy step
4. FTP credentials reference GitHub secrets (not hardcoded)
5. Protocol is set to ftps
6. local-dir points to ./dist/
7. server-dir points to ./
</verification>

<success_criteria>
- Workflow file is valid YAML and committed to repo
- Push to main triggers automated build + FTP deploy
- Site is accessible at https://brianboy.ch after successful deployment
</success_criteria>

<output>
After completion, create `.planning/phases/04-seo-deployment/04-03-SUMMARY.md`
</output>
